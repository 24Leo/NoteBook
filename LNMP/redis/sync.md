* 主死从上，主恢复过来后需要和从同步。
    * slave 会记住旧 master 的旧 replication ID（唯一标识从服务器自身） 和复制偏移量
    * 这两个都是主服务器返回的。如果没有怎么办
* 主从同步原理：**从服务器命令流追赶主服务器的命令流**。
    * 主服务器默认维护一个1M大小的repl_backlog，所有的dirty命令都会放到这里面。然后通信时发送给slaves。
    
##同步过程
* 下载redis源码，然后编译两份redis放到不同的目录下，其中一份当作server端口为9000，另一份为从服务器端口为8999。
* 当然为了方便追踪，我们可以在编译源代码之前添加一些日志或其他返回值，这样方便跟踪。

我们在从服务器执行slaveof IP:PORT之后，就会发现返回OK完事了，但是redis从服务器需要和主服务器进行复杂的底层交互，这个对用户是透明的，涉及到的命令有ping、psync（以前是sync，现在两者都支持）。
    * 另外同步后接下来主从也会一直保持通信。这个也是透明的。
        * 因为服务器需要将新命令流发送过来。
    
###从服务器状态机
* 定时调用replicationCron方法
    * 频率可以设置，默认是1s一次
    
    
    
    
    
###主服务器状态机
* 预同步阶段，发送一个新行（\n，啥都没有）给所有客户端：标记即将进行同步，等待主服务器创建rdb文件。
    * 刷新从服务器最后通信交互时间

[return](README.md)
